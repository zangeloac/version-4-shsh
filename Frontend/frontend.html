<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Security Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f9ff; color: #1f2937; }
        .nav-btn.active { background-color: #dbeafe; border-bottom: 3px solid #2563eb; font-weight: bold; }
        .status-alert { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .doughnut-inner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-blue-600 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                    <span class="text-white text-xl font-bold">SecurityHub</span>
                </div>
                <div class="flex space-x-4">
                    <button onclick="switchView('home')" class="nav-btn active px-3 py-2 rounded text-sm bg-white" data-target="home">Home</button>
                    <button onclick="switchView('simulator')" class="nav-btn px-3 py-2 rounded text-sm bg-white" data-target="simulator">Simulator</button>
                    <button onclick="switchView('assessment')" class="nav-btn px-3 py-2 rounded text-sm bg-white" data-target="assessment">Risk Assessment</button>
                    <button onclick="switchView('shop')" class="nav-btn px-3 py-2 rounded text-sm bg-white" data-target="shop">Shop</button>
                </div>
                <div class="flex items-center bg-white px-3 py-1 rounded-full shadow-sm">
                    <div id="api-status-dot" class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                    <span id="api-status-text" class="text-xs font-bold">Connecting...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-6 max-w-7xl mx-auto w-full">
        <!-- VIEW: HOME -->
        <div id="view-home" class="view-section space-y-8">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg shadow-lg text-white p-8">
                <h1 class="text-4xl font-bold">Security Dashboard</h1>
                <p class="text-blue-100">Live monitoring via Python Backend.</p>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
                <div id="home-status-card" class="bg-white p-6 rounded shadow border-l-4 border-green-500">
                    <p class="text-sm font-bold text-gray-500 uppercase">System Status</p>
                    <h3 id="home-status-text" class="text-2xl font-bold text-green-700 mt-1">SECURE</h3>
                </div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                    <p class="text-sm font-bold text-gray-500 uppercase">Active Triggers</p>
                    <h3 id="home-active-count" class="text-4xl font-bold text-blue-700 mt-1">0</h3>
                </div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-purple-500">
                    <p class="text-sm font-bold text-gray-500 uppercase">Risk Score</p>
                    <h3 id="home-risk-score" class="text-4xl font-bold text-purple-700 mt-1">--%</h3>
                </div>
            </div>
        </div>

        <!-- VIEW: SIMULATOR -->
        <div id="view-simulator" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold pl-3 border-l-4 border-green-400">Live Monitor</h2>
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded shadow p-6 border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-4">Simulate Event</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <select id="sim-type" class="p-2 border rounded"><option value="motion">Motion</option><option value="door">Door</option><option value="fire">Fire</option></select>
                            <input type="text" id="sim-location" placeholder="Location (e.g. Kitchen)" class="p-2 border rounded">
                        </div>
                        <button onclick="simulateEvent()" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">Trigger Event</button>
                    </div>
                    <div class="bg-white rounded shadow p-6">
                        <h3 class="font-bold text-blue-800 mb-4">Active Sensors</h3>
                        <div id="sensor-grid" class="grid grid-cols-2 gap-4"><p>Loading...</p></div>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-white rounded shadow p-6 h-[600px] flex flex-col">
                    <h3 class="font-bold text-blue-800 mb-4">Live Log</h3>
                    <div id="event-log" class="overflow-y-auto flex-grow space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: RISK ASSESSMENT -->
        <div id="view-assessment" class="view-section hidden grid lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-2xl font-bold mb-6">Assessment</h2>
                <form id="risk-form" class="space-y-4"></form>
                <button onclick="calcRisk()" class="w-full bg-blue-600 text-white font-bold py-3 rounded mt-6">Calculate Score</button>
            </div>
            <div class="bg-white p-6 rounded shadow text-center relative">
                <h3 class="text-xl font-bold mb-4">Your Score</h3>
                <div class="relative w-64 h-64 mx-auto"><canvas id="riskChart"></canvas><div id="score-text" class="doughnut-inner">0%</div></div>
                <button onclick="switchView('shop')" class="mt-6 w-full bg-indigo-600 text-white py-2 rounded">View Recommended Products</button>
            </div>
        </div>

        <!-- VIEW: SHOP -->
        <div id="view-shop" class="view-section hidden">
            <h1 class="text-4xl font-bold text-center mb-8">Security Shop</h1>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded shadow overflow-hidden p-4 text-center">
                    <div class="text-4xl mb-2">üîê</div><h3 class="font-bold">Smart Lock</h3>
                    <a href="https://amazon.com/s?k=smart+lock" target="_blank" class="block bg-indigo-600 text-white py-2 rounded mt-4">View on Amazon</a>
                </div>
                <div class="bg-white rounded shadow overflow-hidden p-4 text-center">
                    <div class="text-4xl mb-2">üì∑</div><h3 class="font-bold">Outdoor Camera</h3>
                    <a href="https://amazon.com/s?k=security+camera" target="_blank" class="block bg-indigo-600 text-white py-2 rounded mt-4">View on Amazon</a>
                </div>
                <div class="bg-white rounded shadow overflow-hidden p-4 text-center">
                    <div class="text-4xl mb-2">üì°</div><h3 class="font-bold">Sensor Kit</h3>
                    <a href="https://amazon.com/s?k=sensor+kit" target="_blank" class="block bg-indigo-600 text-white py-2 rounded mt-4">View on Amazon</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:8000';
        let sensorData = [], eventHistory = [], riskChart = null;

        // --- NAVIGATION ---
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-100', 'active');
                if(b.dataset.target === id) b.classList.add('bg-blue-100', 'active');
            });
            if(id === 'simulator') refreshData();
        }

        // --- API ---
        async function checkHealth() {
            try {
                await fetch(`${API_BASE}/health`);
                document.getElementById('api-status-dot').className = "w-3 h-3 rounded-full bg-green-500 mr-2";
                document.getElementById('api-status-text').innerText = "Connected";
                connectWS();
            } catch(e) {
                document.getElementById('api-status-dot').className = "w-3 h-3 rounded-full bg-red-500 mr-2";
                document.getElementById('api-status-text').innerText = "Offline";
            }
        }

        function connectWS() {
            const ws = new WebSocket(`ws://localhost:8000/ws`);
            ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                if(data.type === 'event') {
                    eventHistory.unshift(data.event);
                    renderLog();
                    if(data.event.source.includes('Sensor')) fetchSensors(); // Refresh sensors on trigger
                }
            };
        }

        async function fetchSensors() {
            try {
                const res = await fetch(`${API_BASE}/sensors`);
                sensorData = await res.json();
                renderSensors();
                
                // Update Active Count
                const active = sensorData.filter(s => s.is_triggered).length;
                document.getElementById('home-active-count').innerText = active;
                
                // Update System Status
                const hasCritical = eventHistory.some(e => e.level === 'critical' && (new Date() - new Date(e.timestamp)) < 3600000);
                const statusCard = document.getElementById('home-status-card');
                if (hasCritical || active > 0) {
                    statusCard.classList.replace('border-green-500', 'border-red-500');
                    statusCard.classList.add('status-alert');
                    document.getElementById('home-status-text').innerText = "ALERT";
                    document.getElementById('home-status-text').classList.replace('text-green-700', 'text-red-700');
                }
            } catch(e) {}
        }

        function renderSensors() {
            const grid = document.getElementById('sensor-grid');
            grid.innerHTML = sensorData.map(s => `
                <div class="${s.is_triggered ? 'bg-red-50 border-red-400' : 'bg-green-50 border-green-400'} border-l-4 p-4 rounded shadow flex justify-between">
                    <div><b>${s.name}</b><br><span class="text-xs">${s.type}</span></div>
                    <div class="text-right">
                        <span class="${s.is_triggered ? 'text-red-600' : 'text-green-600'} font-bold">${s.is_triggered ? 'TRIGGERED' : 'SECURE'}</span><br>
                        <button onclick="toggleSensor('${s.id}', ${!s.is_triggered})" class="text-xs underline text-blue-600">Toggle</button>
                    </div>
                </div>
            `).join('');
        }

        async function toggleSensor(id, val) {
            await fetch(`${API_BASE}/sensors/${id}/trigger`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({value: val})
            });
            fetchSensors();
        }

        async function refreshData() {
            fetchSensors();
            const res = await fetch(`${API_BASE}/events`);
            eventHistory = await res.json();
            renderLog();
        }

        function renderLog() {
            document.getElementById('event-log').innerHTML = eventHistory.slice(0, 30).map(e => `
                <div class="p-2 border-l-4 ${e.level === 'critical' ? 'border-red-500 bg-red-50' : 'border-blue-300 bg-blue-50'} text-sm">
                    <div class="flex justify-between text-xs text-gray-500"><span>${new Date(e.timestamp).toLocaleTimeString()}</span><span class="uppercase">${e.level}</span></div>
                    <div><b>${e.source}</b>: ${JSON.stringify(e.payload || {})}</div>
                </div>
            `).join('');
        }

        // --- SIMULATOR ---
        async function simulateEvent() {
            const type = document.getElementById('sim-type').value;
            const loc = document.getElementById('sim-location').value;
            if(!loc) return alert("Enter location");

            // Check if sensor exists
            const match = sensorData.find(s => s.name.toLowerCase().includes(loc.toLowerCase()) && s.type === type);
            
            if(match) {
                await toggleSensor(match.id, true);
            } else {
                // Manually log if no sensor match (or you could create one via API if extended)
                await fetch(`${API_BASE}/logs`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({level: type === 'fire' ? 'critical' : 'warn', source: `Simulated: ${type} at ${loc}`, payload: {manual: true}})
                });
            }
            refreshData();
        }

        // --- RISK ASSESSMENT ---
        const questions = ["Deadbolt locks?", "Motion sensors?", "Secure windows?", "Audible alarm?", "Exterior lighting?", "Evacuation plan?", "Cameras?", "Code changes?", "Hidden valuables?", "Smoke detectors?"];
        document.getElementById('risk-form').innerHTML = questions.map((q,i) => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                <label>${i+1}. ${q}</label>
                <div><input type="radio" name="q${i}" value="10"> Y <input type="radio" name="q${i}" value="0"> N</div>
            </div>
        `).join('');

        function calcRisk() {
            let score = 0;
            const data = new FormData(document.getElementById('risk-form'));
            for(let val of data.values()) score += parseInt(val);
            
            document.getElementById('score-text').innerText = score + "%";
            
            if(riskChart) riskChart.destroy();
            riskChart = new Chart(document.getElementById('riskChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [score, 100-score], backgroundColor: [score>=80?'#4ade80':'#f87171', '#e5e7eb'] }] },
                options: { cutout: '75%', plugins: { tooltip: {enabled: false} } }
            });
            
            // Save locally for persistence in this demo
            localStorage.setItem('lastRiskScore', score);
            document.getElementById('home-risk-score').innerText = score + "%";
        }

        // --- INIT ---
        window.onload = () => {
            checkHealth();
            refreshData();
            switchView('home');
            const savedScore = localStorage.getItem('lastRiskScore');
            if(savedScore) document.getElementById('home-risk-score').innerText = savedScore + "%";
        };
    </script>
</body>
</html>